<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Med4Me ‚Äî Doctor Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1: #1a1a2e;
    --bg2: #16213e;
    --accent: #0f4c75;
    --accent-light: #3282b8;
    --bot: rgba(15, 76, 117, 0.15);
    --user: #3282b8;
    --muted: rgba(255,255,255,0.7);
    --border: rgba(255,255,255,0.1);
  }
  html,body{height:100%;margin:0;padding:0;font-family:'Roboto',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
  
  /* Top header */
  header{padding:14px 16px;background:rgba(15, 76, 117, 0.3);display:flex;justify-content:space-between;align-items:center;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(10px)}
  .header-title{font-size:1.2em}
  .header-user{font-size:0.9em;color:rgba(255,255,255,0.85)}
  .logout-link{color:var(--accent-light);cursor:pointer;text-decoration:underline;margin-left:10px}
  
  /* Main container with sidebar */
  #main-container{display:flex;max-width:1200px;margin:18px auto;height:calc(100vh - 90px);gap:16px;padding:0 14px}
  
  /* Sidebar */
  #sidebar{width:280px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);border-radius:12px;padding:16px;border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
  #sidebar h3{margin:0 0 12px 0;font-size:1.1em}
  .sidebar-controls{display:flex;gap:8px;margin-bottom:12px}
  .sidebar-btn{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(50, 130, 184, 0.1);color:#fff;cursor:pointer;font-size:0.85em;transition:all 0.2s}
  .sidebar-btn:hover{background:rgba(50, 130, 184, 0.2);transform:translateY(-1px)}
  #patient-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
  .patient-item{padding:10px;background:rgba(255,255,255,0.06);border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all 0.2s}
  .patient-item:hover{background:rgba(50, 130, 184, 0.15);border-color:var(--accent-light)}
  .patient-item.active{background:rgba(50, 130, 184, 0.25);border-color:var(--accent-light)}
  .patient-id{font-weight:700;margin-bottom:4px}
  .patient-meta{font-size:0.8em;color:var(--muted)}
  .doctor-note{margin-top:12px;padding:10px;background:rgba(50, 130, 184, 0.08);border-radius:8px;font-size:0.85em;color:var(--muted);border-left:3px solid var(--accent-light)}
  
  /* Chat interface */
  #chat-interface{flex:1;display:flex;flex-direction:column;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);border-radius:12px;padding:14px;border:1px solid var(--border)}
  #chat-container{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .message{max-width:78%;padding:12px 16px;border-radius:18px;line-height:1.35;word-break:break-word;box-shadow:0 6px 16px rgba(0,0,0,0.2)}
  .bot-message{align-self:flex-start;background:var(--bot);color:#fff;border-bottom-left-radius:6px;opacity:0;transform:translateX(-18px);animation:bubbleIn .28s forwards;border:1px solid rgba(50, 130, 184, 0.2)}
  .bot-message.purple{background:rgba(15, 76, 117, 0.25);border:1px solid rgba(50, 130, 184, 0.3)}
  .user-message{align-self:flex-end;background:linear-gradient(135deg, var(--accent-light), var(--accent));color:#fff;border-bottom-right-radius:6px;box-shadow:0 6px 12px rgba(0,0,0,0.3)}
  .history{font-size:0.9rem;color:#3282b8;margin:6px 0;padding-left:8px;border-left:3px solid #3282b8}
  .rec-section{margin:10px 0;padding:10px;background:rgba(15, 76, 117, 0.1);border-radius:8px;border-left:3px solid #3282b8}
  .rec-section.warning{border-left-color:#e74c3c;background:rgba(231, 76, 60, 0.1)}
  @keyframes bubbleIn{to{opacity:1;transform:none}}
  .typing{display:inline-flex;gap:6px;align-items:center}
  .typing-dot{width:8px;height:8px;background:#fff;border-radius:50%;opacity:0;animation:dot 1s infinite}
  .typing-dot:nth-child(2){animation-delay:.18s}
  .typing-dot:nth-child(3){animation-delay:.36s}
  @keyframes dot{0%,80%,100%{opacity:0}40%{opacity:1}}
  #input-area{display:flex;gap:10px;padding:12px;border-radius:10px;background:rgba(15, 76, 117, 0.1);align-items:center;border:1px solid var(--border);margin-top:10px}
  #chat-input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.08);color:#fff;font-size:1rem;outline:none;transition:all 0.3s}
  #chat-input:focus{border-color:var(--accent-light);background:rgba(255,255,255,0.12)}
  #send-btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(135deg, var(--accent-light), var(--accent));color:#fff;font-weight:700;cursor:pointer;transition:all .15s}
  #send-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(50, 130, 184, 0.4)}
  #send-btn:disabled{opacity:.45;cursor:not-allowed;transform:none;background:rgba(50, 130, 184, 0.3)}
  #action-buttons{display:flex;gap:10px;margin-top:10px}
  .action-btn{flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg, #e74c3c, #c0392b);color:#fff;font-weight:700;cursor:pointer;transition:all 0.3s}
  .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(231, 76, 60, 0.4)}
  .tooltip{display:inline-block;position:relative;cursor:pointer;color:var(--muted);font-weight:700}
  .tooltip .tooltiptext{visibility:hidden;opacity:0;transition:opacity .18s;position:absolute;bottom:140%;left:50%;transform:translateX(-50%);background:#222;padding:8px;border-radius:8px;color:#fff;font-size:.85rem;width:220px;text-align:left;box-shadow:0 6px 20px rgba(0,0,0,.3);z-index:10}
  .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
  .muted-note{font-size:.85rem;color:rgba(255,255,255,0.75);margin-top:6px;text-align:center}
  
  @media (max-width:768px){
    #main-container{flex-direction:column;height:auto}
    #sidebar{width:100%;max-height:200px}
    #chat-interface{min-height:500px}
  }
</style>
</head>
<body>
<header>
  <div class="header-title">ü©∫ Med4Me ‚Äî Doctor Chat</div>
  <div class="header-user">
    Logged in as <strong id="username-display"></strong>
    <span class="logout-link" id="header-logout">Logout</span>
  </div>
</header>

<div id="main-container">
  <!-- Sidebar -->
  <div id="sidebar">
    <h3>My Patients</h3>
    <div class="sidebar-controls">
      <button class="sidebar-btn" id="refresh-patients">Refresh</button>
      <button class="sidebar-btn" id="new-patient-sidebar">+ New Patient</button>
    </div>
    <div id="patient-list">
      <div style="color:var(--muted);text-align:center;padding:20px;">Loading patients...</div>
    </div>
    <div class="doctor-note">
      <strong>Doctor Controls</strong><br/>
      Your patients are scoped to your account ‚Äî another doctor can have the same patient_id without mixing records.
    </div>
  </div>

  <!-- Chat Interface -->
  <div id="chat-interface">
    <div id="chat-container" aria-label="Chat messages"></div>

    <div id="input-area" aria-label="Chat input area">
      <input id="chat-input" type="text" placeholder="Type here..." aria-label="Chat input" autocomplete="off" />
      <button id="send-btn" disabled>Send</button>
    </div>

    <div id="action-buttons" style="display:none">
      <button class="action-btn" id="new-patient-btn">New Patient</button>
    </div>

    <div class="muted-note">Tip: Patient ID format required: <strong>P12345</strong></div>
  </div>
</div>

<script>
const BASE_URL = 'http://localhost:5000';

document.addEventListener('DOMContentLoaded', ()=>{
  if(!sessionStorage.getItem('doctor')){
    window.location.href = 'login.html';
    return;
  }

  const username = sessionStorage.getItem('doctor');
  const userId = sessionStorage.getItem('med4me_user_id');
  document.getElementById('username-display').textContent = username;

  const chatContainer = document.getElementById('chat-container');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const newPatientBtn = document.getElementById('new-patient-btn');
  const newPatientSidebar = document.getElementById('new-patient-sidebar');
  const refreshPatientsBtn = document.getElementById('refresh-patients');
  const patientList = document.getElementById('patient-list');
  const actionButtons = document.getElementById('action-buttons');
  const headerLogout = document.getElementById('header-logout');

  let step = 0;
  let patientData = {};
  let currentPatients = [];

  // Logout handlers
  headerLogout.addEventListener('click', logout);
  function logout(){
    sessionStorage.clear();
    localStorage.removeItem('med4me_user');
    window.location.href='login.html';
  }

  // Load patients on start
  loadMyPatients();

  function loadMyPatients(){
    patientList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">Loading...</div>';
    fetch(`${BASE_URL}/api/my/patients?user_id=${userId}`)
      .then(res => res.json())
      .then(data => {
        if(data.success && data.patients){
          currentPatients = data.patients;
          renderPatientList();
        } else {
          patientList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">No patients yet</div>';
        }
      })
      .catch(err => {
        console.error(err);
        patientList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">Error loading patients</div>';
      });
  }

  function renderPatientList(){
    if(currentPatients.length === 0){
      patientList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">No patients yet</div>';
      return;
    }

    patientList.innerHTML = '';
    currentPatients.forEach(patient => {
      const item = document.createElement('div');
      item.className = 'patient-item';
      item.innerHTML = `
        <div class="patient-id">${escapeHtml(patient.patient_id)}</div>
        <div class="patient-meta">
          Visits: ${patient.visits_count}<br/>
          Last: ${patient.last_visit ? escapeHtml(patient.last_visit) : 'N/A'}
        </div>
      `;
      item.addEventListener('click', () => selectPatient(patient.patient_id));
      patientList.appendChild(item);
    });
  }

  function selectPatient(pid){
    // Reset chat
    step = 0;
    patientData = {patient_id: pid};
    actionButtons.style.display = 'none';
    chatContainer.innerHTML = '';
    chatInput.value = '';
    sendBtn.disabled = true;
    
    // Highlight in sidebar
    document.querySelectorAll('.patient-item').forEach(item => {
      item.classList.remove('active');
      if(item.querySelector('.patient-id').textContent === pid){
        item.classList.add('active');
      }
    });

    // Start consultation
    botReply(`Selected patient: <strong>${pid}</strong>`);
    fetchPatientHistory(pid);
  }

  refreshPatientsBtn.addEventListener('click', loadMyPatients);
  newPatientSidebar.addEventListener('click', startNewPatient);
  newPatientBtn.addEventListener('click', startNewPatient);

  function startNewPatient(){
    step = 0;
    patientData = {};
    actionButtons.style.display = 'none';
    chatContainer.innerHTML = '';
    chatInput.value = '';
    sendBtn.disabled = true;
    document.querySelectorAll('.patient-item').forEach(item => item.classList.remove('active'));
    askNextQuestion();
    chatInput.focus();
  }

  function botReply(content, type){
    const typing = document.createElement('div');
    typing.className = 'message bot-message typing';
    typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    if(type === 'genetic') typing.classList.add('purple');
    chatContainer.appendChild(typing);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    const delay = 600 + Math.min(content.replace(/<[^>]*>/g,'').length * 12, 1400);
    setTimeout(()=>{
      typing.remove();
      const msg = document.createElement('div');
      msg.className = 'message bot-message';
      if(type === 'genetic') msg.classList.add('purple');
      msg.innerHTML = content;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }, delay);
  }

  function userBubble(text){
    const el = document.createElement('div');
    el.className = 'message user-message';
    el.textContent = text;
    chatContainer.appendChild(el);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function isValidPatientId(v){ return /^P\d+$/.test(v); }
  function isValidAge(v){ return /^\d{1,3}$/.test(v) && Number(v) > 0 && Number(v) < 150; }
  function isValidGender(v){ return /^(male|female|m|f)$/i.test(v); }
  function isValidGenetic(v){ return v.length >= 2; }
  function isValidSymptoms(v){ return /[a-zA-Z]/.test(v) && v.length >= 3; }

  function validateCurrentInput(){
    const v = chatInput.value.trim();
    let ok = false;
    switch(step){
      case 0: ok = isValidPatientId(v); break;
      case 1: ok = isValidAge(v); break;
      case 2: ok = isValidGender(v); break;
      case 3: ok = isValidGenetic(v); break;
      case 4: ok = isValidSymptoms(v); break;
      default: ok = false;
    }
    sendBtn.disabled = !ok;
  }

  chatInput.addEventListener('input', validateCurrentInput);
  chatInput.addEventListener('keydown', (e)=>{ 
    if(e.key === 'Enter' && !sendBtn.disabled){ 
      e.preventDefault(); 
      handleSend(); 
    } 
  });

  function askNextQuestion(){
    switch(step){
      case 0: botReply("Please enter the <strong>Patient ID</strong> (format <code>P12345</code>) or choose from My Patients."); break;
      case 1: botReply("Enter the patient's <strong>Age</strong> (numbers only):"); break;
      case 2: botReply("Enter the patient's <strong>Gender</strong> (Male/Female or M/F):"); break;
      case 3:
        botReply(`Enter any relevant <strong>Genetic/Family History</strong>
          <span class="tooltip">‚Ñπ
            <span class="tooltiptext">Examples: Family history of diabetes, heart disease, cancer, hypertension, etc. Or type 'none' if not applicable.</span>
          </span>:`, 'genetic');
        break;
      case 4: botReply("Enter the patient's <strong>Symptoms</strong> (describe in detail):"); break;
      case 5: sendRecommendation(); break;
    }
  }

  function handleSend(){
    const raw = chatInput.value.trim();
    if(!raw) return;
    
    let valid = false;
    switch(step){
      case 0: valid = isValidPatientId(raw); break;
      case 1: valid = isValidAge(raw); break;
      case 2: valid = isValidGender(raw); break;
      case 3: valid = isValidGenetic(raw); break;
      case 4: valid = isValidSymptoms(raw); break;
    }
    
    if(!valid){
      botReply("‚ùå Input not valid. Please follow the required format.");
      return;
    }

    userBubble(raw);

    if(step === 0){
      patientData.patient_id = raw;
      chatInput.value = '';
      sendBtn.disabled = true;
      fetchPatientHistory(raw);
      return;
    }
    if(step === 1){ 
      patientData.age = raw; 
      step++; 
      chatInput.value=''; 
      sendBtn.disabled=true; 
      askNextQuestion(); 
      return; 
    }
    if(step === 2){
      const norm = /^(m|male)$/i.test(raw) ? 'male' : 'female';
      patientData.gender = norm;
      step++; 
      chatInput.value=''; 
      sendBtn.disabled=true; 
      askNextQuestion(); 
      return;
    }
    if(step === 3){ 
      patientData.genetic_history = raw; 
      step++; 
      chatInput.value=''; 
      sendBtn.disabled=true; 
      askNextQuestion(); 
      return; 
    }
    if(step === 4){ 
      patientData.symptoms = raw; 
      patientData.created_by = userId;
      step++; 
      chatInput.value=''; 
      sendBtn.disabled=true; 
      askNextQuestion(); 
      return; 
    }
  }

  function fetchPatientHistory(pid){
    botReply("Checking patient history...");
    fetch(`${BASE_URL}/api/patients/${encodeURIComponent(pid)}/history?doctor_id=${userId}`)
      .then(res => res.json())
      .then(data=>{
        if(!data || !data.success){
          botReply("Could not fetch history. Proceeding as new patient.");
          step = 1; 
          askNextQuestion();
          return;
        }

        if(data.history && data.history.length > 0){
          let historyHtml = "<strong>üìã Past Visits:</strong><br>";
          data.history.forEach((visit, idx) => {
            historyHtml += `<div class="history">Visit ${idx+1} (${visit.date})<br/>Symptoms: ${escapeHtml(visit.symptoms || '')}<br/>Diagnosis: ${escapeHtml(visit.diagnosis || '')}<br/>Medicine: ${escapeHtml(visit.medicine || '').substring(0, 100)}...</div>`;
          });
          botReply(historyHtml);

          const last = data.history[data.history.length - 1] || {};
          patientData.age = last.age || "";
          patientData.gender = last.gender || "";
          patientData.genetic_history = last.genetic_history || "Not provided";

          botReply(`<strong>Existing Patient Details:</strong><br/>Age: ${escapeHtml(patientData.age)}<br/>Gender: ${escapeHtml(patientData.gender)}<br/>Genetic History: ${escapeHtml(patientData.genetic_history)}`);

          step = 4;
          askNextQuestion();
        } else {
          botReply("No past history found. Proceeding as new patient.");
          step = 1; 
          askNextQuestion();
        }
      })
      .catch(err=>{
        console.error(err);
        botReply("Error fetching history. Proceeding as new patient.");
        step = 1; 
        askNextQuestion();
      })
      .finally(()=>{ chatInput.focus(); });
  }

  function sendRecommendation(){
    botReply("üîÑ Generating comprehensive medical recommendation...");
    fetch(`${BASE_URL}/api/recommend`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(patientData)
    })
    .then(res=>res.json())
    .then(data=>{
      if(!data || !data.success){
        botReply("‚ùå Failed to get recommendation from server.");
        actionButtons.style.display = 'flex';
        return;
      }
      
      const r = data.recommendation || {};
      
      let html = '<strong style="font-size:1.1em;">üìã Medical Recommendation</strong><br><br>';
      
      html += '<div class="rec-section">';
      html += '<strong>üîç Diagnosis:</strong><br/>';
      html += escapeHtml(r.Diagnosis || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section">';
      html += '<strong>üíä Medication:</strong><br/>';
      html += formatBullets(r.Medicine || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section">';
      html += '<strong>üîÑ Alternative Medication:</strong><br/>';
      html += formatBullets(r.Alternative || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section">';
      html += '<strong>üèÉ Lifestyle Recommendations:</strong><br/>';
      html += escapeHtml(r.Lifestyle || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section warning">';
      html += '<strong>‚ö†Ô∏è Red Flags / Warning Signs:</strong><br/>';
      html += escapeHtml(r['Red Flags'] || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section">';
      html += '<strong>üìÖ Follow-Up:</strong><br/>';
      html += escapeHtml(r['Follow-Up'] || 'N/A');
      html += '</div>';
      
      html += '<div class="rec-section">';
      html += '<strong>üìù Notes:</strong><br/>';
      html += '<em>' + escapeHtml(r.Notes || 'N/A') + '</em>';
      html += '</div>';
      
      botReply(html);
      actionButtons.style.display = 'flex';
      
      // Refresh patient list
      setTimeout(loadMyPatients, 1000);
    })
    .catch(err=>{
      console.error(err);
      botReply("‚ùå Error connecting to server. Please ensure backend is running on port 5000.");
      actionButtons.style.display = 'flex';
    });
  }

  function formatBullets(text){
    if(!text || text === 'N/A') return 'N/A';
    return text.split('\n')
      .filter(line => line.trim())
      .map(line => {
        if(line.trim().startsWith('-')){
          return escapeHtml(line.trim().substring(1).trim());
        }
        return escapeHtml(line.trim());
      })
      .join('<br/>');
  }

  function escapeHtml(str){
    if(typeof str !== 'string') return '';
    return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  sendBtn.addEventListener('click', handleSend);

  askNextQuestion();
  chatInput.focus();

  const observer = new MutationObserver(()=>{ chatInput.focus(); });
  observer.observe(chatContainer, { childList: true });
});
</script>
</body>
</html>